stages:
  - quality
  - test

variables:
  PYTHON_VERSION: "3.12"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.uv-cache"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

.uv-setup: &uv-setup
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
    - uv python install $PYTHON_VERSION
    - uv sync --all-extras
  cache:
    key: uv-$CI_COMMIT_REF_SLUG
    paths:
      - .uv-cache/
      - .venv/

# Quality Jobs
format:
  stage: quality
  <<: *uv-setup
  script:
    - uv run ruff format . --check

lint:
  stage: quality
  <<: *uv-setup
  script:
    - uv run ruff check .

typecheck:
  stage: quality
  <<: *uv-setup
  script:
    - uv run basedpyright --level error
    - uv run ty check .

security:
  stage: quality
  <<: *uv-setup
  script:
    - uv run bandit -r src/ -c pyproject.toml
    - uv run pip-audit

dead-code:
  stage: quality
  <<: *uv-setup
  script:
    - uv run vulture src/ --min-confidence 60
    - uv run pyscn check .

duplication:
  stage: quality
  <<: *uv-setup
  script:
    - uv run pylint src/ --exit-zero
    - npx jscpd .

semgrep:
  stage: quality
  image: semgrep/semgrep:latest
  script:
    - semgrep scan --config auto --config .semgrep/ --error

# Test Job
test:
  stage: test
  <<: *uv-setup
  script:
    - uv run pytest --cov=src --cov-report=term-missing --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
